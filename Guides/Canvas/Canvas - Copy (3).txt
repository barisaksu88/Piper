# Piper - Living Context

*Last updated: 2025-09-06 (rev G)*

---

# 🔝 Always-Read Section

## Rules

### Refresh & Memory

* **Canvas First** → Before every reply, re-read this top section (down to end of Usage).
* User is the architect; ChatGPT is the railmaster/developer. Provide plain-English, step-by-step guidance and drive the rails without asking “what next?”.
* If any instruction conflicts, **this section overrides chat history**.
* Maintain state across replies (Rails, Known Issues, KGB, Architecture, Call Graph).
* ChatGPT updates Canvas only for rails progress, KGB title, and callgraph.

### Development Flow

* Stay on rails; off-rail requests = PARKED.
* One change → smoke test → KGB tag. Tiny scope: plan → patch → smoke → tag → next.
* Tag format: `KGB-YYYY-MM-DD_<RAIL><step>_<slug>`
* Prefer undo/backup; keep changes atomic and auditable. If a step fails twice → REVERT to last KGB snapshot and PARK it.
* **Railmaster auto‑unparks:** I decide when to unpark parked items and where they belong. I do **not** ask which to do first; I will unpark or re‑park and record it in Rails/Parked with rationale.
* No piling changes or “fix-the-fix” loops.
* Layout constants live in `ui/layout_constants.py`. All geometry/theme numbers must come from there.
* Edits: full-script if ≤200 lines, full-function if >200 lines. Warn if file >300 lines or function >50 lines.
* Prefer components (ui/components/\*) and thin entries (<150 lines).

### Response Discipline

Every response must follow the Step Response Template structure and any updates applied to the Canvas  so the user can confirm.

### Step Response Template

```
Canvas: confirm if Always Read part read and any other section
Chapter: <name> | Ring: <Core/Services/UI> | Scope: ✅/🟨/🛑
Plan: ie one tiny change only
Patch: (full file or full function; exact locations if needed)
Smoke (≤3 lines): run → expect → pass condition
KGB: tag on pass / revert+park on fail
Parking: list any out-of-scope or failing items carried forward
Compliance: rings clean; invariants honored; SAFE_MODE; no drift
Examined: scripts that were fully read in Drive/Dropbox mirrors top-to-bottom
Idiotproofed: user edits in scripts confirmed by re-open/re-read
Guardrail: append one-liner — "If this correction does not fix the issue, [revert/maintain]."
```

### Mirrored Files Rule

* Mirrors are the only Truth = .txt mirrors (Drive + Dropbox).
* **Always Check**: never ask user to check, never assume, never say "if it exist"
* **If both mirrors fail rule** → only say: `> Need Drive/Dropbox access to continue.`

## Folder Layout & Architecture (scripts only)

```
├── common/
│   ├── __init__.py
│   ├── config.py
│   ├── logging.py
│   ├── types.py
│   └── utils.py
├── core/
│   ├── __init__.py
│   ├── bg_poller.py
│   ├── bridge.py
│   ├── core_app.py
│   ├── core_commands.py
│   ├── core_machine.py
│   ├── event_queue.py
│   ├── events.py
│   ├── flags.py
│   ├── poll_helpers.py
│   ├── router.py
│   ├── startup.py
│   ├── state_defs.py
│   ├── timers.py
│   └── transition_plan.py
├── entries/
│   ├── __init__.py
│   ├── _app_gui_entry_impl.py
│   ├── _app_gui_entry_impl_backup.py
│   ├── app_cli_entry.py
│   ├── app_gui_entry.py
│   ├── app_wake_entry.py
├── services/
│   ├── adapters/
│   │   └── mock_asr_wake.py
│   ├── asr/
│   │   ├── __init__.py
│   │   └── vosk_adapter.py
│   ├── memory/
│   │   ├── __init__.py
│   ├── persona/
│   │   ├── __init__.py
│   ├── tts/
│   │   ├── __init__.py
│   │   ├── speak_once.py
│   │   └── tts_manager.py
│   ├── wake/
│   │   ├── __init__.py
│   │   └── porcupine_adapter.py
│   ├── __init__.py
│   ├── asr_vosk.py
│   ├── base.py
│   ├── cli_prompt.py
│   ├── persona_adapter.py
│   └── wake_porcupine.py
├── ui/
│   ├── components/
│   │   ├── __init__.py
│   │   ├── chat_pane.py
│   │   ├── controls_pane.py
│   │   ├── logs_pane.py
│   │   └── status_pane.py
│   ├── helpers/
│   │   ├── avatar_fix.py
│   │   ├── chatlog_writer.py
│   │   ├── dev_adapters.py
│   │   ├── dev_controls_mount.py
│   │   ├── gui_ingest.py
│   │   ├── gui_loop.py
│   │   ├── header_bridge.py
│   │   ├── header_utils.py
│   │   ├── init_core.py
│   │   ├── layout_utils.py
│   │   ├── refresh_core.py
│   │   ├── scroll_utils.py
│   │   ├── sink_utils.py
│   │   ├── state_dot.py
│   │   ├── tag_utils.py
│   │   ├── theme_utils.py
│   │   └── viewport_utils.py
│   ├── pane_parts/
│   │   ├── __init__.py
│   │   ├── avatar_pane.py
│   │   ├── chat_pane.py
│   │   ├── header_bar.py
│   │   └── logs_pane.py
│   ├── __init__.py
│   ├── _panes_impl.py
│   ├── dev_tools.py
│   ├── dpg_app.py
│   ├── heartbeat.py
│   ├── ipc_child.py
│   ├── layout_constants.py
│   ├── panes.py
│   ├── state_header.py
│   ├── tailer.py
│   └── theme.py
```

### KGB

*Latest realized snapshot tag:* `KGB-2025-09-08_HDR-MR8_remove-dwell`

### *Drives* \piper guides

Key Files.txt = File role map (GUI orchestration, state dot, hb text, layout const, scroll, avatar).

Anchor.txt = Project rails/constitution (rules, chapters, invariants, runbook).

CLI+GUI Trailing & Testing Guide.txt = 2-terminal run instructions + trailing mechanics + smoke/fix.

State Color Coding Guide.txt = State→color map + dwell + code snippet + smoke test.

## Call Graph

* `entries.app_cli_entry → core.core_machine, services.cli_prompt, logic.command_handler`
* `entries.app_gui_entry → ui.piper_gui, ui.heartbeat, core.core_machine`
* `core.core_machine → logic.wake_cycle, services.tts_manager, services.asr_manager, core.state_signals`
* `ui.piper_gui → services.cli_prompt, core.state_signals, ui.avatar_manager`
* `logic.wake_cycle → services.asr_manager, services.tts_manager`
* `logic.command_handler → services.tts_manager, core.state_signals`
* `ui.heartbeat → core.state_signals`

---

## Index (Read Every Time)

### Current Rails

*Roadmap, update with progress.*

### Parked

*Deferred items or paused experiments.*

### Known Issues

*List of active bugs or broken features.*

&#x20;&#x20;

---

## Usage

* Enforce **Rules** every reply.
* Check Index chapters if relevant (Rails, Known Issues, etc.).
* Keep non-essential sections untouched unless explicitly updated.
* After code changes: update **Call Graph, Rails, Known Issues, Parked, and KGB**.
* If inconsistencies are found between project mirrors and this canvas, they must be called out and corrected immediately.
* Guides are external; always pull them from Drive/Dropbox mirrors if needed

---

# ⬇️ Read-When-Needed Section

## Current Rails (extended)

### Step 1 — Freeze the truth ✅

* Tag a KGB snapshot (no code change): `KGB-2025-09-03_CLEAN_START` (done)

### Step 2 — Header authority ✅

* Keep one place that sets the dot and label: `ui/pane_parts/header_bar.py`.
* All other modules must call `header_bar.set_state_dot(name)` and never recolor directly.

**Targets pruned:** `set_hb_text` re-export dropped; single shim call fenced via alias; callers cleaned.

### Step 3 — Tail classifier ✅ (no-op)

* Classifier parses state and delegates UI to `header_bar.set_state_dot(name)`.
* **Auto-advance dwell decision:** **WON’T-DO for GUI.** Model integration will drive `WAKING→LISTENING→SPEAKING`. GUI dwell removed in MR8. If a temp UX hold is ever needed, use env knob `PIPER_UI_WAKING_DWELL` (default off).

### Step 4 — Refresh bridge (PARKED)

* `ui/helpers/refresh_core.py` only pushes strings & buffers to widgets.
* It may mount Dev pane, but no state parsing.

### Step 5 — Purge duplicates (PARKED)

* Remove extra `set_state_dot` / color maps outside `header_bar`.
* Remove duplicate persona tone/sarcasm parsing outside classifier.
* Remove duplicate `[STATE] …` formatting elsewhere.

### Step 6 — Re-smoke (PARKED)

* CLI + GUI smoke: ensure chat/log only once, header text+dot update, auto-advance handled by model once connected.

## Parked (extended)

* Header dedupe (legacy vs \*\_label tag updates). (To be tackled in Step 5)
* `_app_gui_entry_impl.py` size cut (target ≤150 lines). (To be tackled after Step 6, once all steps are finished)

## Known Issues (extended)

* **Avatar scale is wrong (zoomed-in).**

  * *Symptom:* avatar appears cropped/zoomed.
  * *Status:* **Open**. Address under Step 5 (duplicate purge / single scaler path) and `ui/helpers/avatar_fix.py`.

* **Autoscroll sometimes doesn’t stick.**

  * *Symptom:* Chat/Logs panes stop following the latest line.
  * *Status:* **Open**. Parked to end-of-rails pass; likely in `ui/helpers/scroll_utils.py` with pane glue.
