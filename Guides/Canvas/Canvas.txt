# Piper - Living Context

*Last updated: 2025-09-05*

---

# ğŸ” Always-Read Section

## Rules

### Refresh & Memory

* **Canvas First** â†’ Before every reply, re-read this top section (down to Usage).
* User is the architect; ChatGPT is the railmaster/developer. Provide plain-English, step-by-step guidance and drive the rails without asking â€œwhat next?â€.
* If any instruction conflicts, **this section overrides chat history**.
* Maintain state across replies (Rails, Known Issues, KGB, Architecture, Call Graph).
* ChatGPT updates Canvas only for rails progress, KGB title, and callgraph.

### Development Flow

* Stay on rails; off-rail requests = PARKED.
* One change â†’ smoke test â†’ KGB tag. Tiny scope: plan â†’ patch â†’ smoke â†’ tag â†’ next.
* Tag format: `KGB-YYYY-MM-DD_<RAIL><step>_<slug>`
* If a step fails twice â†’ REVERT to last KGB snapshot and PARK it.
* No piling changes or â€œfix-the-fixâ€ loops.
* Layout constants live in `ui/layout_constants.py`. All geometry/theme numbers must come from there.
* Edits: full-script if â‰¤200 lines, full-function if >200 lines. Warn if file >300 lines or function >50 lines.
* Prefer components (ui/components/\*) and thin entries (<150 lines).

### File Safety

* Never modify `logic/personality.py` (user-owned).
* Prefer undo/backup; keep changes atomic and auditable.

### Mirroring & Anchors

* Follow mirroring rules; anchors are permanent unless explicitly removed.
* If asked to bypass mirroring/anchors, confirm with the user.

### Response Discipline

Every response must:

* Begin with: *â€œI have re-read the Always-Read section.â€*
* Follow the Step Response Template structure.
* After each fix, end with: *â€œIf this correction does not fix the issue, \[revert/maintain].â€*

### Step Response Template

```
Chapter: <name> | Ring: <Core/Services/UI> | Scope: âœ…/ğŸŸ¨/ğŸ›‘
Plan: one tiny change only
Patch: (full file or full function; exact locations if needed)
Smoke (â‰¤3 lines): run â†’ expect â†’ pass condition
KGB: tag on pass / revert+park on fail
Parking: list any out-of-scope or failing items carried forward
Compliance: rings clean; invariants honored; SAFE_MODE; no drift
Mirrors: assistant confirms existence in Drive/Dropbox mirrors; never ask user to check; if both mirrors fail â†’ reply with `> Need Drive/Dropbox access to continue.`
Guardrail: append one-liner â€” "If this correction does not fix the issue, [revert/maintain]."
```

### Mirrored Files Rule

* **Truth** = .txt mirrors (Drive + Dropbox).
* **Examined** = fully read top-to-bottom.
* **Idiotproofed** = change confirmed by re-open/re-read.
* **Always Check**: never assume.
* **Fail Rule**: if both mirrors fail â†’ say: `> Need Drive/Dropbox access to continue.`
* Example:

  * Drive/Dropbox examined: `entries/_app_gui_entry_impl.txt`, `ui/panes.txt`
  * Idiotproofed: `ui/layout_constants.txt` (viewport size update)

## Folder Layout & Architecture (scripts only)

```
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ config.py
â”‚   â”œâ”€â”€ logging.py
â”‚   â”œâ”€â”€ types.py
â”‚   â””â”€â”€ utils.py
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ bg_poller.py
â”‚   â”œâ”€â”€ bridge.py
â”‚   â”œâ”€â”€ core_app.py
â”‚   â”œâ”€â”€ core_commands.py
â”‚   â”œâ”€â”€ core_machine.py
â”‚   â”œâ”€â”€ event_queue.py
â”‚   â”œâ”€â”€ events.py
â”‚   â”œâ”€â”€ flags.py
â”‚   â”œâ”€â”€ poll_helpers.py
â”‚   â”œâ”€â”€ router.py
â”‚   â”œâ”€â”€ startup.py
â”‚   â”œâ”€â”€ state_defs.py
â”‚   â”œâ”€â”€ timers.py
â”‚   â””â”€â”€ transition_plan.py
â”œâ”€â”€ entries/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ _app_gui_entry_impl.py
â”‚   â”œâ”€â”€ _app_gui_entry_impl_backup.py
â”‚   â”œâ”€â”€ app_cli_entry.py
â”‚   â”œâ”€â”€ app_gui_entry.py
â”‚   â”œâ”€â”€ app_wake_entry.py
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ adapters/
â”‚   â”‚   â””â”€â”€ mock_asr_wake.py
â”‚   â”œâ”€â”€ asr/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ vosk_adapter.py
â”‚   â”œâ”€â”€ memory/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ persona/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ tts/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ speak_once.py
â”‚   â”‚   â””â”€â”€ tts_manager.py
â”‚   â”œâ”€â”€ wake/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â””â”€â”€ porcupine_adapter.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ asr_vosk.py
â”‚   â”œâ”€â”€ base.py
â”‚   â”œâ”€â”€ cli_prompt.py
â”‚   â”œâ”€â”€ persona_adapter.py
â”‚   â””â”€â”€ wake_porcupine.py
â”œâ”€â”€ ui/
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ chat_pane.py
â”‚   â”‚   â”œâ”€â”€ controls_pane.py
â”‚   â”‚   â”œâ”€â”€ logs_pane.py
â”‚   â”‚   â””â”€â”€ status_pane.py
â”‚   â”œâ”€â”€ helpers/
â”‚   â”‚   â”œâ”€â”€ avatar_fix.py
â”‚   â”‚   â”œâ”€â”€ chatlog_writer.py
â”‚   â”‚   â”œâ”€â”€ dev_adapters.py
â”‚   â”‚   â”œâ”€â”€ dev_controls_mount.py
â”‚   â”‚   â”œâ”€â”€ gui_ingest.py
â”‚   â”‚   â”œâ”€â”€ gui_loop.py
â”‚   â”‚   â”œâ”€â”€ header_bridge.py
â”‚   â”‚   â”œâ”€â”€ header_utils.py
â”‚   â”‚   â”œâ”€â”€ init_core.py
â”‚   â”‚   â”œâ”€â”€ layout_utils.py
â”‚   â”‚   â”œâ”€â”€ refresh_core.py
â”‚   â”‚   â”œâ”€â”€ scroll_utils.py
â”‚   â”‚   â”œâ”€â”€ sink_utils.py
â”‚   â”‚   â”œâ”€â”€ state_dot.py
â”‚   â”‚   â”œâ”€â”€ tag_utils.py
â”‚   â”‚   â”œâ”€â”€ theme_utils.py
â”‚   â”‚   â””â”€â”€ viewport_utils.py
â”‚   â”œâ”€â”€ pane_parts/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ avatar_pane.py
â”‚   â”‚   â”œâ”€â”€ chat_pane.py
â”‚   â”‚   â”œâ”€â”€ header_bar.py
â”‚   â”‚   â””â”€â”€ logs_pane.py
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ _panes_impl.py
â”‚   â”œâ”€â”€ dev_tools.py
â”‚   â”œâ”€â”€ dpg_app.py
â”‚   â”œâ”€â”€ heartbeat.py
â”‚   â”œâ”€â”€ ipc_child.py
â”‚   â”œâ”€â”€ layout_constants.py
â”‚   â”œâ”€â”€ panes.py
â”‚   â”œâ”€â”€ state_header.py
â”‚   â”œâ”€â”€ tailer.py
â”‚   â””â”€â”€ theme.py
```

## Call Graph

* `entries.app_cli_entry â†’ core.core_machine, services.cli_prompt, logic.command_handler`
* `entries.app_gui_entry â†’ ui.piper_gui, ui.heartbeat, core.core_machine`
* `core.core_machine â†’ logic.wake_cycle, services.tts_manager, services.asr_manager, core.state_signals`
* `ui.piper_gui â†’ services.cli_prompt, core.state_signals, ui.avatar_manager`
* `logic.wake_cycle â†’ services.asr_manager, services.tts_manager`
* `logic.command_handler â†’ services.tts_manager, core.state_signals`
* `ui.heartbeat â†’ core.state_signals`

## KGB

KGB-2025-09-05\_B07\_header\_stable

05.09.2025 Friday, 11:41

---

## Index (Read Every Time)

### Current Rails

*Roadmap, update with progress.*

### Key Files

*Quick reference on file responsibilities.*

### Known Issues

*List of active bugs or broken features.*

### Parked

*Deferred items or paused experiments.*

### Persistent Guides (short notes)

* Anchors, mirroring, trailing, state color coding, etc. â†’ see extended chapters below.

### Reference Library

* Cleanup rails, rerail wrapups, architecture snapshots, experimental notes (read on request).

### Behavior & Persona

*Short rules on persona behavior.*

### State & GUI

*Short rules on state transitions and GUI behavior.*

---

## Usage

* Enforce **Rules + Core Sections** every reply.
* Check Index chapters if relevant (Rails, Known Issues, etc.).
* Keep non-essential sections untouched unless explicitly updated.
* After code changes: update **Call Graph, Rails, Known Issues, Parked, and KGB**.
* If inconsistencies are found between project mirrors and this canvas, they must be called out and corrected immediately.

---

# â¬‡ï¸ Read-When-Needed Section

## Current Rails (extended)

### Step 1 â€” Freeze the truth âœ…

* Tag a KGB snapshot (no code change): `KGB-2025-09-03_CLEAN_START` (done)

### Step 2 â€” Header authority ğŸŸ¨

* Keep one place that sets the dot and label: `ui/pane_parts/header_bar.py`.
* All other modules must call `header_bar.set_state_dot(name)` and never recolor directly.
* **we are here**

### Step 3 â€” Tail classifier (PARKED)

* Keep state detection in `entries/_app_gui_entry_impl.py` (`_classify_and_buffer`).
* It writes `current_state` and queues logs once.
* No recolor; only calls `header_bar.set_state_dot(name)`.

### Step 4 â€” Refresh bridge (PARKED)

* `ui/helpers/refresh_core.py` only pushes strings & buffers to widgets.
* It may mount Dev pane, but no state parsing.

### Step 5 â€” Purge duplicates (PARKED)

* Remove extra `set_state_dot` / color maps outside `header_bar`.
* Remove duplicate persona tone/sarcasm parsing outside classifier.
* Remove duplicate `[STATE] â€¦` formatting elsewhere.

### Step 6 â€” Re-smoke (PARKED)

* CLI + GUI smoke: ensure chat/log only once, header text+dot update, auto-advance works.

## Parked (extended)

* Auto-advance WAKING â†’ LISTENING dwell (\~0.6s). (To be tackled in Step 3)
* Header dedupe (legacy vs \*\_label tag updates). (To be tackled in Step 5)
* `_app_gui_entry_impl.py` size cut (target â‰¤150 lines). (To be tackled after Step 6, once all steps are finished)

## Key Files (extended)

* `core/core_machine.py` â†’ state machine, wake/sleep logic
* `services/cli_prompt.py` â†’ prompt formatting
* `ui/piper_gui.py` â†’ Dear PyGui frontend
* `scripts/dev_agent.py` â†’ patch & restart tool
* `logic/personality.py` â†’ Piper persona (read-only)
* `services/tts_manager.py` â†’ TTS orchestration

## Known Issues (extended)

* Avatar scale is wrong (zoomed in).
* Wake transition not happening.
* Autoscroll sometimes fails (needs further testing).

## Persistent Guides (digest)

* Anchors & Mirroring rules â€” mirrors are the only truth, anchors persist unless explicitly removed.
* Trailing/testing guide â€” dual-window testing, CLI+GUI trailing.
* State color coding â€” dot + header must follow the color map.
* Persona control â€” sarcasm/tone toggles wired only through persona config.

(Full verbatim guide from v2.1 can be expanded on request.)

## Reference Library (verbatim)

* Rerail wrapups (RERAIL1, RERAIL2, RERAIL3)
* Cleanup rails docs & symbol maps
* Additional architecture snapshots
* Any experimental notes not marked as persistent

## Behavior & Persona (extended)

* On wake, greet: **â€œHello sir!â€**
* Persona only from `logic/personality.py` â€” never overridden.
* Barge-in interrupts TTS; auto-sleep returns to idle after silence.

## State & GUI (extended)

* State transitions: `SLEEPING â†’ WAKING â†’ LISTENING â†’ THINKING â†’ SPEAKING` (and back).
* GUI color coding follows the State Color Guide; CLI+GUI trailing behavior per the testing guides.
* Dual-window testing (CLI + GUI) is standard during smoke tests.
